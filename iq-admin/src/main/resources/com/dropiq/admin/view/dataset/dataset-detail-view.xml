<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<view xmlns="http://jmix.io/schema/flowui/view"
      title="msg://DatasetDetailView.title"
      focusComponent="form">
    <data>
        <instance id="datasetDc"
                  class="com.dropiq.admin.entity.Dataset">
            <fetchPlan extends="_base">
                <property name="dataSource" fetchPlan="_base"/>
                <property name="metadata"/>
                <property name="tags"/>
            </fetchPlan>
            <loader/>
        </instance>
        <collection id="dataSourcesDc"
                    class="com.dropiq.admin.entity.DataSource">
            <fetchPlan extends="_base"/>
            <loader id="dataSourcesDl">
                <query>
                    <![CDATA[select ds from DataSource ds where ds.status = 'ACTIVE' order by ds.name]]>
                </query>
            </loader>
        </collection>
        <collection id="productsDc"
                    class="com.dropiq.admin.entity.Product">
            <fetchPlan extends="_base">
                <property name="originalPrice"/>
                <property name="sellingPrice"/>
                <property name="markupPercentage"/>
                <property name="stock"/>
                <property name="available"/>
                <property name="active"/>
                <property name="optimizationStatus"/>
                <property name="primaryImageUrl"/>
            </fetchPlan>
            <loader id="productsDl">
                <query>
                    <![CDATA[select p from Product p where p.dataset = :dataset order by p.name]]>
                </query>
            </loader>
        </collection>
    </data>
    <actions>
        <action id="saveAction" type="detail_saveClose"/>
        <action id="closeAction" type="detail_close"/>
    </actions>
    <facets>
        <dataLoadCoordinator auto="true"/>
    </facets>
    <layout>
        <tabSheet id="tabSheet" width="100%" height="100%">
            <!-- General Tab -->
            <tab id="generalTab" label="msg://generalTab">
                <vbox padding="true" spacing="true">
                    <!-- Dataset Stats Component -->
                    <hbox id="statsContainer" spacing="true" width="100%"
                          css="background: var(--lumo-contrast-5pct); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                        <!-- Stats cards will be populated programmatically -->
                    </hbox>

                    <formLayout id="form" dataContainer="datasetDc">
                        <textField id="nameField" property="name" required="true" width="100%"/>
                        <textArea id="descriptionField" property="description" height="4em" width="100%"/>
                        <comboBox id="dataSourceField" property="dataSource"
                                  colspan="dataSourcesDc" required="true" width="100%"/>
                        <comboBox id="statusField" property="status" width="200px"/>
                    </formLayout>

                    <hbox spacing="true" padding="true">
                        <button id="createFromSourceButton" text="msg://createFromSourceAction"
                                icon="PLUS" themeNames="primary"/>
                        <button id="syncButton" text="msg://syncAction"
                                icon="REFRESH" themeNames="success"/>
                        <button id="optimizeButton" text="msg://optimizeAction"
                                icon="MAGIC" themeNames="primary"/>
                    </hbox>
                </vbox>
            </tab>

            <!-- Settings Tab (same as before) -->
            <tab id="settingsTab" label="msg://settingsTab">
                <vbox padding="true" spacing="true">
                    <details summaryText="msg://pricingSettings" opened="true">
                        <formLayout dataContainer="datasetDc">
                            <bigDecimalField id="defaultMarkupField" property="defaultMarkup"
                                             width="200px"/>
                            <bigDecimalField id="minProfitMarginField" property="minProfitMargin"
                                              width="200px"/>
                            <checkbox id="autoPriceUpdateField" property="autoPriceUpdate"/>
                            <checkbox id="autoStockUpdateField" property="autoStockUpdate"/>
                        </formLayout>
                    </details>

                    <details summaryText="msg://aiSettings" opened="true">
                        <formLayout dataContainer="datasetDc">
                            <checkbox id="aiOptimizationEnabledField" property="aiOptimizationEnabled"/>
                            <checkbox id="seoOptimizationEnabledField" property="seoOptimizationEnabled"/>
                            <checkbox id="trendAnalysisEnabledField" property="trendAnalysisEnabled"/>
                            <checkbox id="imageAnalysisEnabledField" property="imageAnalysisEnabled"/>
                            <checkbox id="autoCategorizationField" property="autoCategorization"/>
                        </formLayout>
                    </details>

                    <details summaryText="msg://syncSettings" opened="false">
                        <formLayout dataContainer="datasetDc">
                            <checkbox id="autoSyncField" property="autoSync"/>
                            <textField id="syncIntervalHoursField" property="syncIntervalHours"
                                       width="200px"/>
                        </formLayout>
                    </details>
                </vbox>
            </tab>

            <!-- Enhanced Products Tab -->
            <tab id="productsTab" label="msg://productsTab">
                <vbox padding="true" spacing="true" height="100%">
                    <!-- Products Header -->
                    <hbox spacing="true" alignItems="CENTER" width="100%">
                        <h3 text="msg://productsInDataset"/>
<!--                        <badge id="productCountBadge" text="0" variant="PRIMARY"/>-->

                        <!-- Product Actions -->
                        <button id="filterProductsButton" text="msg://filter"
                                icon="SEARCH" themeNames="tertiary-inline"/>
                        <button id="bulkActionsButton" text="msg://bulkActions"
                                icon="ELLIPSIS_DOTS_H" themeNames="tertiary-inline"/>
                        <button id="refreshProductsButton" text="msg://refresh"
                                icon="REFRESH" themeNames="tertiary-inline"/>
                    </hbox>

                    <!-- Products Grid -->
                    <dataGrid id="productsDataGrid"
                              width="100%"
                              height="100%"
                              columnReorderingAllowed="true"
                              dataContainer="productsDc"
                              selectionMode="MULTI">
                        <actions>
                            <action id="editAction" type="list_edit"/>
                            <action id="activateSelectedAction" text="msg://activateSelected" icon="PLAY"/>
                            <action id="deactivateSelectedAction" text="msg://deactivateSelected" icon="PAUSE"/>
                            <action id="optimizeSelectedAction" text="msg://optimizeSelected" icon="MAGIC"/>
                        </actions>
                        <columns resizable="true">
                            <column key="image" width="60px" header="" textAlign="CENTER">
<!--                                <template>-->
<!--                                    <image src="${item.primaryImageUrl}"-->
<!--                                           alternateText="Product"-->
<!--                                           width="40px" height="40px"-->
<!--                                           visible="${item.primaryImageUrl != null}"-->
<!--                                           style="object-fit: cover; border-radius: 4px;"/>-->
<!--                                    <span text="ðŸ“·" visible="${item.primaryImageUrl == null}"-->
<!--                                          style="font-size: 16px; color: var(&#45;&#45;lumo-disabled-text-color);"/>-->
<!--                                </template>-->
                            </column>
                            <column property="name" width="200px" sortable="true"/>
                            <column property="originalPrice" width="100px" header="msg://originalPrice" textAlign="END"/>
                            <column property="sellingPrice" width="100px" header="msg://sellingPrice" textAlign="END"/>
                            <column property="markupPercentage" width="80px" header="%" textAlign="CENTER">
<!--                                <template>-->
<!--                                    <span text="${item.markupPercentage}%"-->
<!--                                          visible="${item.markupPercentage != null}"/>-->
<!--                                </template>-->
                            </column>
                            <column property="stock" width="60px" textAlign="CENTER"/>
                            <column property="available" width="80px" textAlign="CENTER">
<!--                                <template>-->
<!--                                    <icon icon="${item.available ? 'CHECK' : 'CLOSE'}"-->
<!--                                          style="color: ${item.available ? 'var(&#45;&#45;lumo-success-color)' : 'var(&#45;&#45;lumo-error-color)'}"/>-->
<!--                                </template>-->
                            </column>
                            <column property="active" width="60px" textAlign="CENTER">
<!--                                <template>-->
<!--                                    <icon icon="${item.active ? 'CHECK' : 'CLOSE'}"-->
<!--                                          style="color: ${item.active ? 'var(&#45;&#45;lumo-success-color)' : 'var(&#45;&#45;lumo-error-color)'}"/>-->
<!--                                </template>-->
                            </column>
                            <column property="optimizationStatus" width="100px" textAlign="CENTER"/>
                            <column key="actions" width="80px" header="" textAlign="CENTER">
<!--                                <template>-->
<!--                                    <hbox spacing="XS">-->
<!--                                        <button icon="EDIT" themeNames="tertiary-inline small"-->
<!--                                                title="msg://editProduct"-->
<!--                                                action="productsDataGrid.editAction"/>-->
<!--                                    </hbox>-->
<!--                                </template>-->
                            </column>
                        </columns>
                    </dataGrid>

                    <!-- Products Footer -->
                    <hbox spacing="true" alignItems="CENTER" width="100%">
                        <span text="msg://selectedProducts" css="color: var(--lumo-secondary-text-color);"/>
                        <span id="selectedCountLabel" text="0" css="font-weight: bold;"/>

                        <!-- Quick Actions for Selected -->
                        <button id="activateSelectedButton" text="msg://activate"
                                icon="PLAY" themeNames="success small"
                                action="productsDataGrid.activateSelectedAction"/>
                        <button id="deactivateSelectedButton" text="msg://deactivate"
                                icon="PAUSE" themeNames="error small"
                                action="productsDataGrid.deactivateSelectedAction"/>
                        <button id="optimizeSelectedButton" text="msg://optimize"
                                icon="MAGIC" themeNames="primary small"
                                action="productsDataGrid.optimizeSelectedAction"/>
                    </hbox>
                </vbox>
            </tab>

            <!-- Statistics Tab (same as before) -->
            <tab id="statisticsTab" label="msg://statisticsTab">
                <vbox padding="true" spacing="true">
                    <hbox spacing="true" width="100%">
                        <vbox spacing="true" width="50%">
                            <h3 text="msg://datasetStatistics"/>
                            <formLayout dataContainer="datasetDc">
                                <textField id="totalProductsField" property="totalProducts"
                                           readOnly="true" width="150px"/>
                                <textField id="activeProductsField" property="activeProducts"
                                           readOnly="true" width="150px"/>
                                <textField id="optimizedProductsField" property="optimizedProducts"
                                           readOnly="true" width="150px"/>
                                <textField id="exportedProductsField" property="exportedProducts"
                                           readOnly="true" width="150px"/>
                            </formLayout>
                        </vbox>

                        <vbox spacing="true" width="50%">
                            <h3 text="msg://syncStatistics"/>
                            <formLayout dataContainer="datasetDc">
                                <textField id="lastSyncField" property="lastSync"
                                           readOnly="true" width="200px"/>
                                <textField id="syncCountField" property="syncCount"
                                           readOnly="true" width="150px"/>
                                <textField id="errorCountField" property="errorCount"
                                           readOnly="true" width="150px"/>
                                <textArea id="lastErrorMessageField" property="lastErrorMessage"
                                          readOnly="true" height="4em" width="100%"/>
                            </formLayout>
                        </vbox>
                    </hbox>
                </vbox>
            </tab>
        </tabSheet>

        <hbox id="detailActions" padding="true" spacing="true">
            <button id="saveAndCloseButton" action="saveAction"/>
            <button id="closeButton" action="closeAction"/>
        </hbox>
    </layout>
</view>